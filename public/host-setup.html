<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Host Setup - Microsoft Teams Meeting</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .setup-screen {
            width: 100vw;
            min-height: 100vh;
            background-color: #f3f2f1;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 40px 20px;
            overflow-y: auto;
        }

        .setup-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            max-width: 900px;
            width: 100%;
            padding: 40px;
            margin-bottom: 40px;
        }

        .setup-title {
            font-size: 28px;
            font-weight: 600;
            color: #252423;
            margin-bottom: 10px;
        }

        .setup-subtitle {
            font-size: 14px;
            color: #605e5c;
            margin-bottom: 30px;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #faf9f8;
            border-radius: 8px;
            border: 1px solid #edebe9;
        }

        .section h3 {
            font-size: 18px;
            font-weight: 600;
            color: #252423;
            margin-bottom: 15px;
        }

        .participant-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            font-size: 14px;
            color: #252423;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .input-group input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #8a8886;
            border-radius: 4px;
            font-size: 14px;
            font-family: 'Segoe UI', sans-serif;
        }

        .input-group input:focus {
            outline: none;
            border-color: #6264a7;
        }

        .generated-link {
            display: none;
            margin-top: 10px;
            padding: 12px;
            background: #e8f4f8;
            border-radius: 4px;
            border: 1px solid #0078d4;
        }

        .generated-link.show {
            display: block;
        }

        .link-text {
            font-size: 13px;
            color: #0078d4;
            word-break: break-all;
            margin-bottom: 8px;
        }

        .btn-small {
            background: #0078d4;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            margin-right: 10px;
        }

        .btn-small:hover {
            background: #106ebe;
        }

        .video-upload-box {
            border: 2px dashed #d2d0ce;
            border-radius: 8px;
            padding: 30px 20px;
            text-align: center;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 15px;
        }

        .video-upload-box:hover {
            border-color: #6264a7;
            background: #f3f2f1;
        }

        .video-upload-box i {
            font-size: 36px;
            color: #6264a7;
            margin-bottom: 10px;
        }

        .video-upload-box p {
            color: #605e5c;
            font-size: 14px;
        }

        .video-upload-box input {
            display: none;
        }

        .video-preview {
            display: none;
            margin-bottom: 15px;
        }

        .video-preview.show {
            display: block;
        }

        .video-preview video {
            width: 100%;
            max-height: 200px;
            border-radius: 8px;
            background: #000;
        }

        .video-info {
            margin-top: 10px;
            padding: 12px;
            background: #f3f2f1;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .video-info span {
            font-size: 14px;
            color: #252423;
        }

        .remove-btn {
            background: none;
            border: none;
            color: #c4314b;
            cursor: pointer;
            font-size: 14px;
            padding: 4px 8px;
        }

        .remove-btn:hover {
            text-decoration: underline;
        }

        .actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 30px;
            padding-top: 30px;
            border-top: 1px solid #edebe9;
        }

        .btn-primary {
            background: #6264a7;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }

        .btn-primary:hover {
            background: #4b4d8c;
        }

        .btn-primary:disabled {
            background: #c8c6c4;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="setup-screen">
        <div class="setup-container">
            <h1 class="setup-title">Host Meeting Setup</h1>
            <p class="setup-subtitle">Enter your name and configure participants</p>

            <!-- Host Name Section -->
            <div class="section">
                <h3>Your Name (Host)</h3>
                <div class="participant-row">
                    <div class="input-group">
                        <label for="host-firstname">First Name</label>
                        <input type="text" id="host-firstname" placeholder="e.g., Sarah">
                    </div>
                    <div class="input-group">
                        <label for="host-lastname">Last Name</label>
                        <input type="text" id="host-lastname" placeholder="e.g., Brown">
                    </div>
                </div>
            </div>

            <!-- Participants Section -->
            <div class="section">
                <h3>Participants (2 maximum)</h3>

                <!-- Participant 1 (with videos) -->
                <div class="participant-row">
                    <div class="input-group">
                        <label for="firstname1">First Name</label>
                        <input type="text" id="firstname1" placeholder="e.g., Jane">
                    </div>
                    <div class="input-group">
                        <label for="lastname1">Last Name</label>
                        <input type="text" id="lastname1" placeholder="e.g., Smith">
                    </div>
                </div>
                <button class="btn-small" onclick="generateLink(1, true)">Generate Link for Participant 1 (with videos)</button>
                <div class="generated-link" id="link1">
                    <div class="link-text" id="linktext1"></div>
                    <button class="btn-small" onclick="copyLink(1)">Copy Link</button>
                </div>

                <!-- Participant 2 -->
                <div class="participant-row" style="margin-top: 20px;">
                    <div class="input-group">
                        <label for="firstname2">First Name</label>
                        <input type="text" id="firstname2" placeholder="e.g., Bob">
                    </div>
                    <div class="input-group">
                        <label for="lastname2">Last Name</label>
                        <input type="text" id="lastname2" placeholder="e.g., Johnson">
                    </div>
                </div>
                <button class="btn-small" onclick="generateLink(2)">Generate Link for Participant 2</button>
                <div class="generated-link" id="link2">
                    <div class="link-text" id="linktext2"></div>
                    <button class="btn-small" onclick="copyLink(2)">Copy Link</button>
                </div>
            </div>

            <!-- Videos Section - Host -->
            <div class="section">
                <h3>Vos Vidéos (Host) - remplacent votre webcam</h3>
                <p style="font-size: 13px; color: #605e5c; margin-bottom: 20px;">Ces vidéos apparaîtront à la place de votre webcam quand vous cliquez Video 1 ou Video 2</p>

                <!-- Video 1 -->
                <div>
                    <label style="font-size: 14px; font-weight: 600; color: #252423; display: block; margin-bottom: 10px;">Host - Video 1</label>
                    <div class="video-upload-box" id="upload-box-1" onclick="document.getElementById('video-input-1').click()">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p><strong>Cliquez pour uploader</strong></p>
                        <p style="font-size: 12px; margin-top: 5px;">MP4, WebM, ou OGG (max 500MB)</p>
                        <input type="file" id="video-input-1" accept="video/mp4,video/webm,video/ogg">
                    </div>
                    <div class="video-preview" id="preview-1">
                        <video id="video-player-1" controls></video>
                        <div class="video-info">
                            <span id="video-name-1">video.mp4</span>
                            <button class="remove-btn" onclick="removeVideo(1)">Remove</button>
                        </div>
                    </div>
                </div>

                <!-- Video 2 -->
                <div style="margin-top: 20px;">
                    <label style="font-size: 14px; font-weight: 600; color: #252423; display: block; margin-bottom: 10px;">Host - Video 2 (Optionnel)</label>
                    <div class="video-upload-box" id="upload-box-2" onclick="document.getElementById('video-input-2').click()">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p><strong>Cliquez pour uploader</strong></p>
                        <p style="font-size: 12px; margin-top: 5px;">MP4, WebM, ou OGG (max 500MB)</p>
                        <input type="file" id="video-input-2" accept="video/mp4,video/webm,video/ogg">
                    </div>
                    <div class="video-preview" id="preview-2">
                        <video id="video-player-2" controls></video>
                        <div class="video-info">
                            <span id="video-name-2">video.mp4</span>
                            <button class="remove-btn" onclick="removeVideo(2)">Remove</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Videos Section - Participant 2 -->
            <div class="section">
                <h3>Vidéos Participant 2</h3>
                <p style="font-size: 13px; color: #605e5c; margin-bottom: 20px;">Ces vidéos seront disponibles pour le Participant 2 (celui avec le lien "with videos")</p>

                <!-- P2 Video 1 -->
                <div>
                    <label style="font-size: 14px; font-weight: 600; color: #252423; display: block; margin-bottom: 10px;">Participant 2 - Video 1</label>
                    <div class="video-upload-box" id="upload-box-p2-1" onclick="document.getElementById('video-input-p2-1').click()">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p><strong>Cliquez pour uploader</strong></p>
                        <p style="font-size: 12px; margin-top: 5px;">MP4, WebM, ou OGG (max 500MB)</p>
                        <input type="file" id="video-input-p2-1" accept="video/mp4,video/webm,video/ogg">
                    </div>
                    <div class="video-preview" id="preview-p2-1">
                        <video id="video-player-p2-1" controls></video>
                        <div class="video-info">
                            <span id="video-name-p2-1">video.mp4</span>
                            <button class="remove-btn" onclick="removeVideoP2(1)">Remove</button>
                        </div>
                    </div>
                </div>

                <!-- P2 Video 2 -->
                <div style="margin-top: 20px;">
                    <label style="font-size: 14px; font-weight: 600; color: #252423; display: block; margin-bottom: 10px;">Participant 2 - Video 2 (Optionnel)</label>
                    <div class="video-upload-box" id="upload-box-p2-2" onclick="document.getElementById('video-input-p2-2').click()">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p><strong>Cliquez pour uploader</strong></p>
                        <p style="font-size: 12px; margin-top: 5px;">MP4, WebM, ou OGG (max 500MB)</p>
                        <input type="file" id="video-input-p2-2" accept="video/mp4,video/webm,video/ogg">
                    </div>
                    <div class="video-preview" id="preview-p2-2">
                        <video id="video-player-p2-2" controls></video>
                        <div class="video-info">
                            <span id="video-name-p2-2">video.mp4</span>
                            <button class="remove-btn" onclick="removeVideoP2(2)">Remove</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Videos Section - Participant 3 (Virtual) -->
            <div class="section">
                <h3>Vidéos Participant 3 (Virtuel)</h3>
                <p style="font-size: 13px; color: #605e5c; margin-bottom: 20px;">Ces vidéos seront jouées pour le participant virtuel (Slot 2 > Participant 3)</p>

                <div class="participant-row">
                    <div class="input-group">
                        <label for="p3-firstname">Prénom du Participant 3</label>
                        <input type="text" id="p3-firstname" placeholder="ex: Michel">
                    </div>
                    <div class="input-group">
                        <label for="p3-lastname">Nom du Participant 3</label>
                        <input type="text" id="p3-lastname" placeholder="ex: Dupont">
                    </div>
                </div>

                <!-- P3 Video 1 -->
                <div>
                    <label style="font-size: 14px; font-weight: 600; color: #252423; display: block; margin-bottom: 10px;">Participant 3 - Video 1</label>
                    <div class="video-upload-box" id="upload-box-p3-1" onclick="document.getElementById('video-input-p3-1').click()">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p><strong>Cliquez pour uploader</strong></p>
                        <p style="font-size: 12px; margin-top: 5px;">MP4, WebM, ou OGG (max 500MB)</p>
                        <input type="file" id="video-input-p3-1" accept="video/mp4,video/webm,video/ogg">
                    </div>
                    <div class="video-preview" id="preview-p3-1">
                        <video id="video-player-p3-1" controls></video>
                        <div class="video-info">
                            <span id="video-name-p3-1">video.mp4</span>
                            <button class="remove-btn" onclick="removeVideoP3(1)">Remove</button>
                        </div>
                    </div>
                </div>

                <!-- P3 Video 2 -->
                <div style="margin-top: 20px;">
                    <label style="font-size: 14px; font-weight: 600; color: #252423; display: block; margin-bottom: 10px;">Participant 3 - Video 2 (Optionnel)</label>
                    <div class="video-upload-box" id="upload-box-p3-2" onclick="document.getElementById('video-input-p3-2').click()">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p><strong>Cliquez pour uploader</strong></p>
                        <p style="font-size: 12px; margin-top: 5px;">MP4, WebM, ou OGG (max 500MB)</p>
                        <input type="file" id="video-input-p3-2" accept="video/mp4,video/webm,video/ogg">
                    </div>
                    <div class="video-preview" id="preview-p3-2">
                        <video id="video-player-p3-2" controls></video>
                        <div class="video-info">
                            <span id="video-name-p3-2">video.mp4</span>
                            <button class="remove-btn" onclick="removeVideoP3(2)">Remove</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="actions">
                <button class="btn-primary" id="start-btn" onclick="startAsHost()">Start Meeting as Host</button>
            </div>

            <!-- Bouton de test -->
            <div style="text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid #edebe9;">
                <p style="font-size: 12px; color: #605e5c; margin-bottom: 10px;">Pour tester sans vidéo:</p>
                <button onclick="testQuickStart()"
                        style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px;">
                    TEST - Quick Start (Host)
                </button>
            </div>
        </div>
    </div>

    <script>
        const baseUrl = window.location.origin;
        let uploadedVideos = { 1: null, 2: null };
        let uploadedVideosP2 = { 1: null, 2: null };
        let uploadedVideosP3 = { 1: null, 2: null };

        // Handle P2 video uploads
        document.getElementById('video-input-p2-1').addEventListener('change', (e) => handleVideoUploadP2(e, 1));
        document.getElementById('video-input-p2-2').addEventListener('change', (e) => handleVideoUploadP2(e, 2));

        function handleVideoUploadP2(event, slot) {
            const file = event.target.files[0];
            if (!file) return;

            if (file.size > 500 * 1024 * 1024) {
                alert('Fichier trop gros. Maximum 500MB.');
                return;
            }

            uploadedVideosP2[slot] = file;

            const videoURL = URL.createObjectURL(file);
            document.getElementById(`video-player-p2-${slot}`).src = videoURL;
            document.getElementById(`video-name-p2-${slot}`).textContent = file.name;
            document.getElementById(`upload-box-p2-${slot}`).style.display = 'none';
            document.getElementById(`preview-p2-${slot}`).classList.add('show');
        }

        function removeVideoP2(slot) {
            uploadedVideosP2[slot] = null;
            document.getElementById(`video-player-p2-${slot}`).src = '';
            document.getElementById(`upload-box-p2-${slot}`).style.display = 'block';
            document.getElementById(`preview-p2-${slot}`).classList.remove('show');
            document.getElementById(`video-input-p2-${slot}`).value = '';
        }

        // Handle P3 video uploads
        document.getElementById('video-input-p3-1').addEventListener('change', (e) => handleVideoUploadP3(e, 1));
        document.getElementById('video-input-p3-2').addEventListener('change', (e) => handleVideoUploadP3(e, 2));

        function handleVideoUploadP3(event, slot) {
            const file = event.target.files[0];
            if (!file) return;

            if (file.size > 500 * 1024 * 1024) {
                alert('Fichier trop gros. Maximum 500MB.');
                return;
            }

            uploadedVideosP3[slot] = file;

            const videoURL = URL.createObjectURL(file);
            document.getElementById(`video-player-p3-${slot}`).src = videoURL;
            document.getElementById(`video-name-p3-${slot}`).textContent = file.name;
            document.getElementById(`upload-box-p3-${slot}`).style.display = 'none';
            document.getElementById(`preview-p3-${slot}`).classList.add('show');
        }

        function removeVideoP3(slot) {
            uploadedVideosP3[slot] = null;
            document.getElementById(`video-player-p3-${slot}`).src = '';
            document.getElementById(`upload-box-p3-${slot}`).style.display = 'block';
            document.getElementById(`preview-p3-${slot}`).classList.remove('show');
            document.getElementById(`video-input-p3-${slot}`).value = '';
        }

        // Generate participant link
        function generateLink(participantNum, hasVideos = false) {
            const firstname = document.getElementById(`firstname${participantNum}`).value.trim();
            const lastname = document.getElementById(`lastname${participantNum}`).value.trim();

            if (!firstname || !lastname) {
                alert('Please enter both first and last name');
                return;
            }

            const fullName = `${firstname} ${lastname}`;
            let link = `${baseUrl}/participant?name=${encodeURIComponent(fullName)}`;

            // Add hasVideos parameter if participant can upload videos
            if (hasVideos) {
                link += `&hasVideos=true`;
            }

            document.getElementById(`linktext${participantNum}`).textContent = link;
            document.getElementById(`link${participantNum}`).classList.add('show');

            // Store link in sessionStorage for retrieval in meeting
            sessionStorage.setItem(`participantLink${participantNum}`, link);
            sessionStorage.setItem(`participantName${participantNum}`, fullName);
        }

        function copyLink(participantNum) {
            const linkText = document.getElementById(`linktext${participantNum}`).textContent;
            navigator.clipboard.writeText(linkText).then(() => {
                // Link copied silently without popup
                console.log('Link copied to clipboard');
            }).catch(err => {
                console.error('Failed to copy:', err);
            });
        }

        // Handle video uploads
        document.getElementById('video-input-1').addEventListener('change', (e) => handleVideoUpload(e, 1));
        document.getElementById('video-input-2').addEventListener('change', (e) => handleVideoUpload(e, 2));

        function handleVideoUpload(event, slot) {
            const file = event.target.files[0];
            if (!file) return;

            // Check file size (500MB max)
            if (file.size > 500 * 1024 * 1024) {
                alert('File is too large. Maximum size is 500MB.');
                return;
            }

            // Store video file
            uploadedVideos[slot] = file;

            // Show preview
            const videoURL = URL.createObjectURL(file);
            document.getElementById(`video-player-${slot}`).src = videoURL;
            document.getElementById(`video-name-${slot}`).textContent = file.name;
            document.getElementById(`upload-box-${slot}`).style.display = 'none';
            document.getElementById(`preview-${slot}`).classList.add('show');
        }

        function removeVideo(slot) {
            uploadedVideos[slot] = null;
            document.getElementById(`video-player-${slot}`).src = '';
            document.getElementById(`upload-box-${slot}`).style.display = 'block';
            document.getElementById(`preview-${slot}`).classList.remove('show');
            document.getElementById(`video-input-${slot}`).value = '';
        }

        function testQuickStart() {
            // Quick test function - sets host with default name
            sessionStorage.setItem('isHost', 'true');
            sessionStorage.setItem('userName', 'Test Host');
            console.log('Quick start as host');
            window.location.href = '/meeting';
        }

        async function storeVideosInIndexedDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('TeamsCloneDB', 2);

                request.onerror = () => reject(request.error);

                request.onsuccess = (event) => {
                    const db = event.target.result;
                    const transaction = db.transaction(['videos'], 'readwrite');
                    const store = transaction.objectStore('videos');

                    // Clear old videos first
                    store.clear();

                    // Store Host videos (ID 1, 2)
                    if (uploadedVideos[1]) {
                        store.put({ id: 1, file: uploadedVideos[1], type: 'host' });
                        console.log('Storing Host Video 1');
                    }
                    if (uploadedVideos[2]) {
                        store.put({ id: 2, file: uploadedVideos[2], type: 'host' });
                        console.log('Storing Host Video 2');
                    }

                    // Store Participant 2 videos (ID 3, 4)
                    if (uploadedVideosP2[1]) {
                        store.put({ id: 3, file: uploadedVideosP2[1], type: 'participant2' });
                        console.log('Storing P2 Video 1');
                    }
                    if (uploadedVideosP2[2]) {
                        store.put({ id: 4, file: uploadedVideosP2[2], type: 'participant2' });
                        console.log('Storing P2 Video 2');
                    }

                    // Store Participant 3 videos (ID 5, 6)
                    if (uploadedVideosP3[1]) {
                        store.put({ id: 5, file: uploadedVideosP3[1], type: 'participant3' });
                        console.log('Storing P3 Video 1');
                    }
                    if (uploadedVideosP3[2]) {
                        store.put({ id: 6, file: uploadedVideosP3[2], type: 'participant3' });
                        console.log('Storing P3 Video 2');
                    }

                    transaction.oncomplete = () => {
                        console.log('All videos stored in IndexedDB');
                        resolve();
                    };

                    transaction.onerror = () => reject(transaction.error);
                };

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('videos')) {
                        db.createObjectStore('videos', { keyPath: 'id' });
                    }
                };
            });
        }

        async function startAsHost() {
            console.log('startAsHost called');

            try {
                // Get host name
                const hostFirstname = document.getElementById('host-firstname').value.trim();
                const hostLastname = document.getElementById('host-lastname').value.trim();

                if (!hostFirstname || !hostLastname) {
                    alert('Veuillez entrer votre prénom et nom');
                    return;
                }

                const hostFullName = `${hostFirstname} ${hostLastname}`;

                // Get P3 name
                const p3Firstname = document.getElementById('p3-firstname').value.trim();
                const p3Lastname = document.getElementById('p3-lastname').value.trim();
                const p3FullName = p3Firstname && p3Lastname ? `${p3Firstname} ${p3Lastname}` : '';

                // Store host info
                sessionStorage.setItem('isHost', 'true');
                sessionStorage.setItem('userName', hostFullName);

                // Store P3 info
                if (p3FullName) {
                    sessionStorage.setItem('participant3Name', p3FullName);
                }

                // Store P2 name (from Participant 1 field - the one with videos)
                const p2Firstname = document.getElementById('firstname1').value.trim();
                const p2Lastname = document.getElementById('lastname1').value.trim();
                const p2FullName = p2Firstname && p2Lastname ? `${p2Firstname} ${p2Lastname}` : '';
                if (p2FullName) {
                    sessionStorage.setItem('participant2Name', p2FullName);
                }

                // Store videos in IndexedDB
                await storeVideosInIndexedDB();

                console.log('Redirecting to meeting...');
                window.location.href = '/meeting';
            } catch (error) {
                console.error('Error in startAsHost:', error);
                alert('Erreur: ' + error.message);
            }
        }
    </script>
</body>
</html>
